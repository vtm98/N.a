// ====== × ×ª×•× ×™× (×ž×•×¦×¨×™× ×œ×“×•×’×ž×”) ======
const CATEGORIES = [
  { key: "all", label: "×”×›×œ", icon: "â­" },
  { key: "face", label: "×¤× ×™×", icon: "ðŸ§´" },
  { key: "eyes", label: "×¢×™× ×™×™×", icon: "ðŸ‘ï¸" },
  { key: "lips", label: "×©×¤×ª×™×™×", icon: "ðŸ’„" },
  { key: "nails", label: "×¦×™×¤×•×¨× ×™×™×", icon: "ðŸ’…" },
  { key: "tools", label: "×›×œ×™×", icon: "ðŸ–Œï¸" },
];

const PRODUCTS = [
  { id: "p1", name: "×ž×™×™×§××¤ ×ž××˜ ×¢×ž×™×“", category: "face", price: 59, emoji: "ðŸ§´", tag: "×—×“×©" },
  { id: "p2", name: "×§×•× ×¡×™×œ×¨ ×›×™×¡×•×™ ×’×‘×•×”", category: "face", price: 45, emoji: "âœ¨", tag: "×‘×¡×˜ ×¡×œ×¨" },
  { id: "p3", name: "×¤×œ×˜×ª ×¦×œ×œ×™×•×ª 12 ×’×•×•× ×™×", category: "eyes", price: 79, emoji: "ðŸŽ¨", tag: "×˜×¨× ×“×™" },
  { id: "p4", name: "×ž×¡×§×¨×” × ×¤×— ×•×”××¨×›×”", category: "eyes", price: 49, emoji: "ðŸ‘ï¸", tag: "×¢×ž×™×“×”" },
  { id: "p5", name: "×©×¤×ª×•×Ÿ ×ž×˜ ×§×˜×™×¤×ª×™", category: "lips", price: 39, emoji: "ðŸ’„", tag: "××”×•×‘" },
  { id: "p6", name: "×’×œ×•×¡ ×©×§×•×£ ×ž×‘×¨×™×§", category: "lips", price: 29, emoji: "ðŸ’‹", tag: "×§×œ××¡×™" },
  { id: "p7", name: "×œ×§ ×’×³×œ ×‘×‘×™×ª", category: "nails", price: 34, emoji: "ðŸ’…", tag: "×—×¡×›×•× ×™" },
  { id: "p8", name: "×¡×˜ ×ž×‘×¨×©×•×ª ××™×¤×•×¨ (8)", category: "tools", price: 89, emoji: "ðŸ–Œï¸", tag: "×¡×˜" },
];

// ====== ×ž×¦×‘ (state) ======
let activeCategory = "all";
let searchTerm = "";
let cart = loadCart();

// ====== ××œ×ž× ×˜×™× ======
const tabsEl = document.getElementById("tabs");
const catGridEl = document.getElementById("catGrid");
const productGridEl = document.getElementById("productGrid");
const productsTitleEl = document.getElementById("productsTitle");

const cartBtn = document.getElementById("cartBtn");
const bottomCartBtn = document.getElementById("bottomCartBtn");
const cartDrawer = document.getElementById("cartDrawer");
const closeCartBtn = document.getElementById("closeCartBtn");
const backdrop = document.getElementById("backdrop");
const cartCountEl = document.getElementById("cartCount");
const cartItemsEl = document.getElementById("cartItems");
const cartEmptyEl = document.getElementById("cartEmpty");
const cartTotalEl = document.getElementById("cartTotal");
const checkoutBtn = document.getElementById("checkoutBtn");
const checkoutForm = document.getElementById("checkoutForm");

const searchBtn = document.getElementById("searchBtn");
const searchRow = document.getElementById("searchRow");
const searchInput = document.getElementById("searchInput");
const clearSearchBtn = document.getElementById("clearSearchBtn");

document.getElementById("shopNowBtn").addEventListener("click", () => {
  window.scrollTo({ top: productGridEl.offsetTop - 80, behavior: "smooth" });
});
document.getElementById("seeNewBtn").addEventListener("click", () => {
  setCategory("all");
});

// ====== ×¨×™× ×“×•×¨ ======
function renderTabs() {
  tabsEl.innerHTML = "";
  CATEGORIES.forEach((c) => {
    const btn = document.createElement("button");
    btn.className = "tab" + (c.key === activeCategory ? " active" : "");
    btn.textContent = c.label;
    btn.addEventListener("click", () => setCategory(c.key));
    tabsEl.appendChild(btn);
  });
}

function renderCategoriesGrid() {
  catGridEl.innerHTML = "";
  CATEGORIES.filter(c => c.key !== "all").forEach((c) => {
    const item = document.createElement("div");
    item.className = "cat-item";
    item.innerHTML = `
      <div class="cat-circle">${c.icon}</div>
      <div class="cat-label">${c.label}</div>
    `;
    item.addEventListener("click", () => setCategory(c.key));
    catGridEl.appendChild(item);
  });
}

function filteredProducts() {
  return PRODUCTS.filter((p) => {
    const catOk = activeCategory === "all" ? true : p.category === activeCategory;
    const searchOk = !searchTerm
      ? true
      : p.name.toLowerCase().includes(searchTerm.toLowerCase());
    return catOk && searchOk;
  });
}

function categoryLabel(key) {
  return (CATEGORIES.find(c => c.key === key)?.label) || "×ž×•×¦×¨×™×";
}

function renderProducts() {
  const list = filteredProducts();
  productsTitleEl.textContent =
    activeCategory === "all"
      ? (searchTerm ? `×ª×•×¦××•×ª ×¢×‘×•×¨ "${searchTerm}"` : "×ž×•×ž×œ×¦×™×")
      : `${categoryLabel(activeCategory)}${searchTerm ? ` Â· "${searchTerm}"` : ""}`;

  productGridEl.innerHTML = "";
  list.forEach((p) => {
    const card = document.createElement("div");
    card.className = "product-card";

    card.innerHTML = `
      <div class="product-img" aria-hidden="true">${p.emoji}</div>
      <div class="product-body">
        <div class="product-name">${p.name}</div>
        <div class="product-meta">
          <div>${p.tag}</div>
          <div class="price">â‚ª${p.price}</div>
        </div>

        <div class="add-row">
          <div class="qty" aria-label="×›×ž×•×ª">
            <button data-act="minus" aria-label="×”×¤×—×ª">âˆ’</button>
            <span data-act="count">1</span>
            <button data-act="plus" aria-label="×”×•×¡×£">+</button>
          </div>
          <button class="add-btn">×”×•×¡×£ ×œ×¢×’×œ×”</button>
        </div>
      </div>
    `;

    let qty = 1;
    const countEl = card.querySelector('[data-act="count"]');
    card.querySelector('[data-act="minus"]').addEventListener("click", () => {
      qty = Math.max(1, qty - 1);
      countEl.textContent = qty;
    });
    card.querySelector('[data-act="plus"]').addEventListener("click", () => {
      qty += 1;
      countEl.textContent = qty;
    });

    card.querySelector(".add-btn").addEventListener("click", () => {
      addToCart(p.id, qty);
      qty = 1;
      countEl.textContent = qty;
      openCart();
    });

    productGridEl.appendChild(card);
  });
}

function renderCart() {
  const items = cartItemsDetailed();
  cartItemsEl.innerHTML = "";

  if (items.length === 0) {
    cartEmptyEl.hidden = false;
  } else {
    cartEmptyEl.hidden = true;
    items.forEach((it) => {
      const row = document.createElement("div");
      row.className = "cart-item";
      row.innerHTML = `
        <div class="cart-emoji" aria-hidden="true">${it.emoji}</div>
        <div>
          <div class="cart-name">${it.name}</div>
          <div class="cart-sub">×›×ž×•×ª: ${it.qty} Â· â‚ª${it.price} ×œ×™×—'</div>
        </div>
        <div class="cart-actions">
          <div class="price">â‚ª${it.price * it.qty}</div>
          <button class="remove-btn">×”×¡×¨</button>
        </div>
      `;
      row.querySelector(".remove-btn").addEventListener("click", () => {
        removeFromCart(it.id);
      });
      cartItemsEl.appendChild(row);
    });
  }

  cartCountEl.textContent = String(cartCount());
  cartTotalEl.textContent = `â‚ª${cartTotal()}`;
}

// ====== ×¢×’×œ×ª ×§× ×™×•×ª (localStorage) ======
function loadCart() {
  try {
    return JSON.parse(localStorage.getItem("glowcart_cart")) || {};
  } catch {
    return {};
  }
}

function saveCart() {
  localStorage.setItem("glowcart_cart", JSON.stringify(cart));
}

function cartCount() {
  return Object.values(cart).reduce((sum, qty) => sum + qty, 0);
}

function cartItemsDetailed() {
  return Object.entries(cart)
    .map(([id, qty]) => {
      const p = PRODUCTS.find(x => x.id === id);
      if (!p) return null;
      return { ...p, qty };
    })
    .filter(Boolean);
}

function cartTotal() {
  return cartItemsDetailed().reduce((sum, it) => sum + it.price * it.qty, 0);
}

function addToCart(productId, qty) {
  cart[productId] = (cart[productId] || 0) + qty;
  saveCart();
  renderCart();
}

function removeFromCart(productId) {
  delete cart[productId];
  saveCart();
  renderCart();
}

// ====== × ×™×•×•×˜ / ×¤×™×œ×˜×¨ ======
function setCategory(key) {
  activeCategory = key;
  renderTabs();
  renderProducts();
  window.scrollTo({ top: productGridEl.offsetTop - 80, behavior: "smooth" });
}

function toggleSearch(show) {
  searchRow.hidden = !show;
  if (show) {
    searchInput.focus();
  } else {
    searchTerm = "";
    searchInput.value = "";
    renderProducts();
  }
}

// ====== Drawer ======
function openCart() {
  cartDrawer.classList.add("open");
  cartDrawer.setAttribute("aria-hidden", "false");
  backdrop.hidden = false;
}

function closeCart() {
  cartDrawer.classList.remove("open");
  cartDrawer.setAttribute("aria-hidden", "true");
  backdrop.hidden = true;
}

// ====== Events ======
cartBtn.addEventListener("click", openCart);
bottomCartBtn.addEventListener("click", openCart);
closeCartBtn.addEventListener("click", closeCart);
backdrop.addEventListener("click", closeCart);

searchBtn.addEventListener("click", () => toggleSearch(searchRow.hidden));
clearSearchBtn.addEventListener("click", () => toggleSearch(false));

searchInput?.addEventListener("input", (e) => {
  searchTerm = e.target.value.trim();
  renderProducts();
});

checkoutBtn.addEventListener("click", () => {
  checkoutForm.hidden = !checkoutForm.hidden;
});

checkoutForm.addEventListener("submit", (e) => {
  e.preventDefault();
  const name = document.getElementById("fullName").value.trim();
  const phone = document.getElementById("phone").value.trim();
  const address = document.getElementById("address").value.trim();

  const items = cartItemsDetailed()
    .map(it => `- ${it.name} x${it.qty} (â‚ª${it.price * it.qty})`)
    .join("\n");

  const total = cartTotal();

  // ×”×—×œ×£/×™ ×œ×ž×¡×¤×¨ ×©×œ×š (×‘×¤×•×¨×ž×˜ ×‘×™× ×œ××•×ž×™ ×‘×œ×™ +, ×œ×ž×©×œ ×™×©×¨××œ: 9725XXXXXXXX)
  const WHATSAPP_NUMBER = "972500000000";

  const msg =
`×”×™×™, ×× ×™ ×¨×•×¦×” ×œ×”×–×ž×™×Ÿ:
×©×: ${name}
×˜×œ×¤×•×Ÿ: ${phone}
×›×ª×•×‘×ª: ${address}

×ž×•×¦×¨×™×:
${items}

×¡×”×´×›: â‚ª${total}`;

  const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;
  window.open(url, "_blank");
});

// ====== Init ======
renderTabs();
renderCategoriesGrid();
renderProducts();
renderCart();

// ×¡×™×ž×•×Ÿ ×ª×—×ª×•×Ÿ (×¡×ª× UI)
document.querySelectorAll(".nav-item").forEach(btn => {
  btn.addEventListener("click", () => {
    document.querySelectorAll(".nav-item").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");
  });
});
